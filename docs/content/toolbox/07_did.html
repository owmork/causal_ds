<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2022-11-23">
<title>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS - Difference-in-Differences</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/toolbox/08_iv.html" rel="next">
<link href="../../content/toolbox/06_match.html" rel="prev">
<link href="../../images/favicon_cds_16x16.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/iconify-1.0.7/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/icon_cds_text.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><b>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS</b></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../content/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../submission/submission.html" rel="" target="">
 <span class="menu-text">Submission</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://communicating.tuhh.de/w-11-students/channels/discussion-causal-data-science" rel="" target="">
 <span class="menu-text"><iconify-icon inline="" icon="cib:mattermost" style="font-size: 1.25em;"></iconify-icon></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/toolbox/05_rct.html"><b>Toolbox</b></a></li><li class="breadcrumb-item"><a href="../../content/toolbox/07_did.html">Difference-in-Differences</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><b>Introduction</b></span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text"><b>Fundamentals</b></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/01_a_prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probability Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/01_b_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/02_reg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression and Statistical Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/03_caus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Causality</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/04_dag.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Directed Acyclic Graphs</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text"><b>Toolbox</b></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/05_rct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Randomized Controlled Trials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/06_match.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Matching and Subclassification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/07_did.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Difference-in-Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/08_iv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/09_rdd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Discontinuity</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li>
<a href="#application" id="toc-application" class="nav-link" data-scroll-target="#application">Application</a>
  <ul class="collapse">
<li>
<a href="#parallel-trends" id="toc-parallel-trends" class="nav-link" data-scroll-target="#parallel-trends">Parallel trends</a>
  <ul class="collapse">
<li><a href="#scenario-a" id="toc-scenario-a" class="nav-link" data-scroll-target="#scenario-a">Scenario A</a></li>
  <li><a href="#scenario-b" id="toc-scenario-b" class="nav-link" data-scroll-target="#scenario-b">Scenario B</a></li>
  </ul>
</li>
  <li><a href="#event-study" id="toc-event-study" class="nav-link" data-scroll-target="#event-study">Event Study</a></li>
  <li>
<a href="#modeling" id="toc-modeling" class="nav-link" data-scroll-target="#modeling">Modeling</a>
  <ul class="collapse">
<li><a href="#scenario-a-1" id="toc-scenario-a-1" class="nav-link" data-scroll-target="#scenario-a-1">Scenario A</a></li>
  <li><a href="#scenario-b-1" id="toc-scenario-b-1" class="nav-link" data-scroll-target="#scenario-b-1">Scenario B</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#assignment" id="toc-assignment" class="nav-link" data-scroll-target="#assignment">Assignment</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Difference-in-Differences</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 23, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header><section id="introduction" class="level1"><h1>Introduction</h1>
<p>Another quasi-experimental method from our toolbox is the <strong>difference-in-differences (DiD)</strong> approach. It is the most popular research design in quantitative and social sciences. As the name implies, the method <strong>captures differences by observing a treatment and a control group over time</strong> to estimate causal average effects.</p>
<p>In its simplest form, DiD compares <strong>two groups</strong> (control and treatment) <strong>at two points in time</strong> (before treatment and after) by observing if and how different both groups change. It is important to note, that both groups do not need to be equal before the treatment.</p>
<p>By taking two differences, <strong>two different kind of biases can be avoided</strong>. First, by comparing both groups at both points in time, any external effect that affects the outcome of both groups in the same way is equalized. Secondly, taking only the difference of a change in consideration, we can disregard selection bias. Potential outcomes can differ:</p>
<p><span class="math display">\[
E[Y_0|D = 0] \gtreqqless E[Y_0|D = 1]
\]</span></p>
<p>We don’t care whether initially treatment and control group are different. We only assume that they <strong>behave similarly in absence of treatment</strong>.</p>
<p>As can be seen in the table, the difference in outcome for the treatment group before and after treatment is <span class="math inline">\(D + T\)</span>, while for the control group it is only <span class="math inline">\(T\)</span>. The difference of these two differences then reduces to only <span class="math inline">\(D\)</span>, which is the treatment effect we want to estimate.</p>
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 8%">
<col style="width: 38%">
<col style="width: 22%">
<col style="width: 7%">
</colgroup>
<thead><tr class="header">
<th>Group</th>
<th>Time</th>
<th>Outcome</th>
<th>1st Difference</th>
<th>DiD</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treatment (D=1)</td>
<td>0</td>
<td><span class="math inline">\(Y= Y_{T=0, D=1}\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>1</td>
<td><span class="math inline">\(Y = Y_{T=0,D=1} + T + D\)</span></td>
<td><span class="math inline">\(T +D\)</span></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td><span class="math inline">\(D\)</span></td>
</tr>
<tr class="even">
<td>Control (D=0)</td>
<td>0</td>
<td><span class="math inline">\(Y = Y_{T=0, D=0}\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>1</td>
<td><span class="math inline">\(Y = Y_{T=0, D=0} + T\)</span></td>
<td><span class="math inline">\(T\)</span></td>
<td></td>
</tr>
</tbody>
</table>
<p>We can also break it down in our known notation:</p>
<p><span class="math display">\[
\delta = ATE = \bigg(E[Y_{D=1}|T=1] - E[Y_{D=1}|T=0] \bigg)- \bigg(E[Y_{D=0}|T=1] - E[Y_{D=0}|T=0]\bigg)
\]</span></p>
<p>Because there are a lot of subscripts, it can also help to write down the formula in pseudo-math:</p>
<p><span class="math display">\[
ATE = (Y_{Treatment, After} - Y_{Treatment, Before}) - (Y_{Control, After} - Y_{Control, Before})
\]</span></p>
<p>Again, opposed to methods where we just know one outcome - the “after” outcome, regardless of whether a unit received or did not receive treatment - we do not have to assume that the potential outcomes <span class="math inline">\(E[Y_0|D=1] = E[Y_0|D=1]\)</span> are equal. That is a big difference, because do not have to assume that observation units are similar in all their characteristics.</p>
<p>Instead DiD hinges on a different assumption, the <strong>parallel trends assumption.</strong> It says that, in absence of treatment for both groups, they would be expected to evolve similarly over time. In other words, we do not expect the potential outcome to be similar, but only the change of outcomes from before to after. It implies that there is no factor that has only an impact on just one of the groups. If units differ in characteristics, they are only allowed to have a constant effect. If the effect varies with time, the parallel trends assumption is violated.</p>
</section><section id="application" class="level1"><h1>Application</h1>
<p>Illustrating the parallel trends assumption is very helpful. By going through two scenarios, we will look at an example where parallel trends are fulfilled and another one where it is violated.</p>
<ul>
<li><p><strong>Scenario A</strong>: parallel trends assumption fulfilled</p></li>
<li><p><strong>Scenario B</strong>: parallel trends assumption violated</p></li>
</ul>
<p>Let’s imagine, you are manager of a company that has two stores, one of them being in City 1 and the other being in City 2. You want to test the effectiveness of a local ad campaign on sales. Therefore, you will run a campaign at the store in City 1 but not in City 2 and keep track of sales in the periods before and after the treatment.</p>
<p>You don’t need to read follow all steps how to generate data for both scenarios, but I’ll leave it in for those who are interested.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data Simulation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math inline">\(Y\)</span> - sales</p>
<p><span class="math inline">\(D\)</span> - true treatment effect</p>
<p><span class="math inline">\(P\)</span> - periods</p>
<p><span class="math inline">\(S\)</span> - store index</p>
<p><span class="math inline">\(X\)</span> - covariate, e.g.&nbsp;ecosystem</p>
<p>With the function <em>generate_data()</em> we generate data with arbitrary values for the number of stores, number of observed periods, the size of the true treatment effect, the timing of treatment and level of noise in the data generating process. Data is generated for both scenarios as can be seen at the suffixes.</p>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details><summary>Function to simulate DiD data</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load tidyverse package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to simulate data</span></span>
<span><span class="va">generate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">S</span> <span class="op">=</span> <span class="fl">2</span>, <span class="co"># number of groups</span></span>
<span>    <span class="va">P</span> <span class="op">=</span> <span class="fl">10</span>, <span class="co"># number of periods</span></span>
<span>    <span class="va">D_size</span> <span class="op">=</span> <span class="fl">1</span>, <span class="co"># effect of treatment</span></span>
<span>    <span class="va">D_time</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># time of treatment</span></span>
<span>    <span class="va">y_0</span> <span class="op">=</span> <span class="fl">50</span>, <span class="co"># base value for y</span></span>
<span>    <span class="va">sd</span> <span class="op">=</span> <span class="fl">1</span>, <span class="co"># standard deviations for randomly generated sequences</span></span>
<span>    <span class="va">scenario</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># create group period dyads</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">P</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">P</span>, <span class="va">S</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># timing and size of treatment (effect)</span></span>
<span>  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="va">D_size</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">D_time</span><span class="op">)</span><span class="op">)</span> <span class="va">D_time</span> <span class="op">&lt;-</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">after</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">p</span> <span class="op">&gt;</span> <span class="va">D_time</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create relation between independent variables and treatment (actually</span></span>
<span>  <span class="co"># other way round, but easier to simulate this way)</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">S</span><span class="op">*</span><span class="va">P</span>, <span class="va">s</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create dependent variable ...</span></span>
<span>  <span class="co"># ... for scenario (A)</span></span>
<span>  <span class="va">y_a</span> <span class="op">&lt;-</span> <span class="va">y_0</span> <span class="op">+</span> <span class="va">delta</span><span class="op">*</span><span class="va">s</span><span class="op">*</span><span class="va">after</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">*</span><span class="va">p</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">S</span><span class="op">*</span><span class="va">P</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ... for scenario (B)</span></span>
<span>  <span class="va">y_b</span> <span class="op">&lt;-</span> <span class="va">y_0</span> <span class="op">+</span> <span class="va">delta</span><span class="op">*</span><span class="va">s</span><span class="op">*</span><span class="va">after</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">*</span><span class="va">p</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">s</span><span class="op">*</span><span class="va">x1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">p</span><span class="op">*</span><span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">S</span><span class="op">*</span><span class="va">P</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add variables to table</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    treat   <span class="op">=</span> <span class="va">s</span>,</span>
<span>    period  <span class="op">=</span> <span class="va">p</span>,</span>
<span>    after   <span class="op">=</span> <span class="va">after</span>,</span>
<span>    x1      <span class="op">=</span> <span class="va">x1</span>,</span>
<span>    sales   <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">{</span><span class="va">y_a</span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="va">y_b</span><span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return table</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We choose to generate a data set with a true treatment effect of 1 and 10 observed periods. For now, we just have one store as a treated unit and one store as a non-treated unit. Later, we will extend it to a larger number of stores per group, but for demonstration purpose, we restrict it to two stores, initially. We have 10 periods with 5 periods before and 5 after treatment. Lastly, we add a little bit of noise.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate one sample for each scenario</span></span>
<span><span class="va">P</span>     <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># number of periods</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">1</span>  <span class="co"># true treatment effect</span></span>
<span></span>
<span><span class="co"># Scenario A</span></span>
<span><span class="va">df_A</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span>P <span class="op">=</span> <span class="va">P</span>, D_size <span class="op">=</span> <span class="va">delta</span>, sd <span class="op">=</span> <span class="fl">0.01</span>, scenario <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scenario B</span></span>
<span><span class="va">df_B</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span>P <span class="op">=</span> <span class="va">P</span>, D_size <span class="op">=</span> <span class="va">delta</span>, sd <span class="op">=</span> <span class="fl">0.01</span>, scenario <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="parallel-trends" class="level2"><h2 class="anchored" data-anchor-id="parallel-trends">Parallel trends</h2>
<section id="scenario-a" class="level3"><h3 class="anchored" data-anchor-id="scenario-a">Scenario A</h3>
<p>To compute an estimated treatment effect, we filter the data to the two periods just around treatment and implement the formulas as in the introduction. Not surprisingly, we get an estimate that is very close to our true treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.1.1] (A) Fulfillment ----</span></span>
<span><span class="co"># Scenario (A)</span></span>
<span><span class="co"># Only show last data point before and first data point after treatment.</span></span>
<span><span class="va">df_A_zoom_in</span>  <span class="op">&lt;-</span> <span class="va">df_A</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">period</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually compute differences</span></span>
<span><span class="co"># Step 1: Difference between treatment and control group BEFORE treatment</span></span>
<span><span class="va">before_control_A</span> <span class="op">&lt;-</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span><span class="va">before_treatment_A</span> <span class="op">&lt;-</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_before_A</span> <span class="op">&lt;-</span> <span class="va">before_treatment_A</span> <span class="op">-</span> <span class="va">before_control_A</span></span>
<span></span>
<span><span class="co"># Step 2: Difference between treatment and control group AFTER treatment</span></span>
<span><span class="va">after_control_A</span> <span class="op">&lt;-</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span><span class="va">after_treatment_A</span> <span class="op">&lt;-</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_after_A</span> <span class="op">&lt;-</span> <span class="va">after_treatment_A</span> <span class="op">-</span> <span class="va">after_control_A</span></span>
<span></span>
<span><span class="co"># Step 3: Difference-in-differences. Unbiased estimate if parallel trends is </span></span>
<span><span class="co"># correctly assumed and there is no hidden confounding. Estimate may vary from </span></span>
<span><span class="co"># true treatment effect, as we also include some noise in the data generating </span></span>
<span><span class="co"># process.</span></span>
<span><span class="va">diff_diff_A</span> <span class="op">&lt;-</span> <span class="va">diff_after_A</span> <span class="op">-</span> <span class="va">diff_before_A</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Estimate: %.2f, True Effect: %.2f"</span>, <span class="va">diff_diff_A</span>, <span class="va">delta</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Estimate: 1.05, True Effect: 1.00"</code></pre>
</div>
</div>
<p>Looking at the last period before and the first period after treatment, the impact of treatment can clearly be seen. The dashed line represents the counterfactual value for the treated group, i.e.&nbsp;the value it would have if it had not been treated. This value is not observed, but by the parallel trends assumptions, it would have developed like the value for the untreated group.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Plots in this chapter
</div>
</div>
<div class="callout-body-container callout-body">
<p>Generating the plots for this chapter is a bit tricky as they contain a lot of annotations and other extensions. I left the code for those who want to replicate it. But you do not worry if you cannot reproduce them.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<details><summary>Plot parallel trends assumption</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute counterfactual sales for treated group</span></span>
<span><span class="va">cf_treat_A</span> <span class="op">&lt;-</span> <span class="va">df_A</span><span class="op">[</span><span class="op">!</span><span class="va">df_A</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"sales"</span><span class="op">]</span> <span class="op">+</span> <span class="va">diff_before_A</span></span>
<span><span class="va">df_A</span><span class="op">[</span><span class="va">df_A</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"sales_cf"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cf_treat_A</span></span>
<span></span>
<span><span class="co"># Add to zoomed in table</span></span>
<span><span class="va">df_A_zoom_in</span> <span class="op">&lt;-</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_A</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot DiD with parallel trends assumption</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_A_zoom_in</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Geographic elements</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">.5</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_A_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales_cf</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, xend <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_A</span>, yend <span class="op">=</span> <span class="va">after_treatment_A</span> <span class="op">-</span> <span class="va">diff_diff_A</span>,</span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"label"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.9</span>, </span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_A</span> <span class="op">-</span> <span class="op">(</span><span class="va">diff_diff_A</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Treatment effect"</span>, size <span class="op">=</span> <span class="fl">3</span>, fill <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.7</span>, </span>
<span>           y <span class="op">=</span> <span class="va">before_control_A</span> <span class="op">+</span> <span class="fl">1.1</span><span class="op">*</span><span class="va">diff_before_A</span> <span class="op">+</span> <span class="fl">.1</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Counterfactual"</span>, size <span class="op">=</span> <span class="fl">4</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Custom scaling and legend</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span><span class="st">""</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5.5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Before\n Treatment"</span>, </span>
<span>                                <span class="st">"Treatment"</span>,</span>
<span>                                <span class="st">"After\n Treatment"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control Group"</span>, <span class="st">"Treatment Group"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Scenario A:\nParallel Trends Assumption"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="07_did_files/figure-html/unnamed-chunk-4-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="If parallel trends assumption can be assumed, treatment effect is valid. Counterfactual line shows how outcome would have been evolved in absence of treatment."><img src="07_did_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:75.0%"></a></p>
<figcaption class="figure-caption">If parallel trends assumption can be assumed, treatment effect is valid. Counterfactual line shows how outcome would have been evolved in absence of treatment.</figcaption></figure>
</div>
</div>
</div>
</section><section id="scenario-b" class="level3"><h3 class="anchored" data-anchor-id="scenario-b">Scenario B</h3>
<p>Repeating the steps for scenario B yields an unexpected result. The estimated treatment effect is different from what we would have expected.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.1.2] (B) Violation ----</span></span>
<span><span class="co"># Scenario (B)</span></span>
<span><span class="co"># Only show last data point before and first data point after treatment.</span></span>
<span><span class="va">df_B_zoom_in</span>  <span class="op">&lt;-</span> <span class="va">df_B</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">period</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually compute differences</span></span>
<span><span class="co"># Step 1: Difference between treatment and control group BEFORE treatment</span></span>
<span><span class="va">before_control_B</span> <span class="op">&lt;-</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span><span class="va">before_treatment_B</span> <span class="op">&lt;-</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_before_B</span> <span class="op">&lt;-</span> <span class="va">before_treatment_B</span> <span class="op">-</span> <span class="va">before_control_B</span></span>
<span></span>
<span><span class="co"># Step 2: Difference between treatment and control group AFTER treatment</span></span>
<span><span class="va">after_control_B</span> <span class="op">&lt;-</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span><span class="va">after_treatment_B</span> <span class="op">&lt;-</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">after</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_after_B</span> <span class="op">&lt;-</span> <span class="va">after_treatment_B</span> <span class="op">-</span> <span class="va">after_control_B</span></span>
<span></span>
<span><span class="co"># Step 3: Difference-in-differences. Unbiased estimate if parallel trends is </span></span>
<span><span class="co"># correctly assumed and there is no hidden confounding. Estimate varies from </span></span>
<span><span class="co"># true treatment effect due to confounding and added noise.</span></span>
<span><span class="va">diff_diff_B</span> <span class="op">&lt;-</span> <span class="va">diff_after_B</span> <span class="op">-</span> <span class="va">diff_before_B</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Estimate: %.2f, True Effect: %.2f"</span>, <span class="va">diff_diff_B</span>, <span class="va">delta</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Estimate: 1.23, True Effect: 1.00"</code></pre>
</div>
</div>
<p>Again, the picture is very similar. Having only four data points, treatment before and after and control before and after, there is no way to test the parallel trends assumption which leaves room for doubt. So how can we check whether we made a mistake or the parallel trends assumption is violated?</p>
<div class="cell" data-layout-align="center">
<details><summary>Plot parallel trends assumption</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute counterfactual sales for treated group</span></span>
<span><span class="va">cf_treat_B</span> <span class="op">&lt;-</span> <span class="va">df_B</span><span class="op">[</span><span class="op">!</span><span class="va">df_B</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"sales"</span><span class="op">]</span> <span class="op">+</span> <span class="va">diff_before_B</span></span>
<span><span class="va">df_B</span><span class="op">[</span><span class="va">df_B</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"sales_cf"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cf_treat_B</span></span>
<span></span>
<span><span class="co"># Add to zoomed in table</span></span>
<span><span class="va">df_B_zoom_in</span> <span class="op">&lt;-</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_B</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot DiD with parallel trends assumption</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_B_zoom_in</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Geographic elements</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">.5</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_B_zoom_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales_cf</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, xend <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_B</span>, yend <span class="op">=</span> <span class="va">after_treatment_B</span> <span class="op">-</span> <span class="va">diff_diff_B</span>,</span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"label"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.9</span>, </span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_B</span> <span class="op">-</span> <span class="op">(</span><span class="va">diff_diff_B</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Treatment effect"</span>, size <span class="op">=</span> <span class="fl">3</span>, fill <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.7</span>, </span>
<span>           y <span class="op">=</span> <span class="va">before_control_B</span> <span class="op">+</span> <span class="fl">1.1</span><span class="op">*</span><span class="va">diff_before_B</span> <span class="op">+</span> <span class="fl">.1</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Counterfactual"</span>, size <span class="op">=</span> <span class="fl">4</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Custom scaling and legend</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span><span class="st">""</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5.5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Before\n Treatment"</span>, </span>
<span>                                <span class="st">"Treatment"</span>,</span>
<span>                                <span class="st">"After\n Treatment"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control Group"</span>, <span class="st">"Treatment Group"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Scenario B:\nParallel Trends Assumption"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="07_did_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Knowing the true treatment effect, we know that the estimated treatment effect is too high. But this plot can’t tell us why."><img src="07_did_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:75.0%"></a></p>
<figcaption class="figure-caption">Knowing the true treatment effect, we know that the estimated treatment effect is too high. But this plot can’t tell us why.</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="event-study" class="level2"><h2 class="anchored" data-anchor-id="event-study">Event Study</h2>
<p>Hence, numerous researchers endeavor to enhance the reliability of their findings through the utilization of an event study. Comparing trends before treatment across treatment and control group, it should show that there was no difference prior to the treatment. <strong>Because if there was no difference before treatment, why should there be difference after the treatment (if not for the treatment itself)?</strong></p>
<p>However, event studies cannot provide full certainty about the parallel trends assumption. There still might be other unobserved factors that could affect the treatment. But still, it is a good way to argue that treatment and control group are comparable.</p>
<div class="cell" data-layout-align="center">
<details><summary>Code: Event Study A</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.2] Event study ----</span></span>
<span><span class="co"># To provide evidence of the credibility in assuming parallel trends, </span></span>
<span><span class="co"># researchers often perform an event study, if possible. Instead of only</span></span>
<span><span class="co"># looking at the last period before and the first period after treatment,</span></span>
<span><span class="co"># further periods are included to examine the validity of the parallel trends</span></span>
<span><span class="co"># assumption and the treatment effect estimate.</span></span>
<span></span>
<span><span class="co"># [1.2.1] (A) Fulfillment ----</span></span>
<span><span class="co"># Zoom out and show that parallel trend assumption is fulfilled in scenario (a)</span></span>
<span></span>
<span><span class="co"># Compute difference in control group</span></span>
<span><span class="va">diff_control_A</span> <span class="op">&lt;-</span> <span class="va">after_control_A</span> <span class="op">-</span> <span class="va">before_control_A</span></span>
<span></span>
<span><span class="co"># Plot event study</span></span>
<span><span class="va">ev_stdy_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_A</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">.5</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_A</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">period</span> <span class="op">&gt;=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales_cf</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, xend <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_A</span>, yend <span class="op">=</span> <span class="va">after_treatment_A</span> <span class="op">-</span> <span class="va">diff_diff_A</span>,</span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Custom scaling and legend</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">P</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control Group"</span>, <span class="st">"Treatment Group"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Scenario A\nEvent Study"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details><summary>Code: Event Study B</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.2.2] (B) Violation----</span></span>
<span><span class="co"># Zoom out and show that parallel trend assumption is violated in scenario (b)</span></span>
<span></span>
<span><span class="co"># Compute difference in treatment group</span></span>
<span><span class="co"># Before treatment</span></span>
<span><span class="va">diff_control_B</span> <span class="op">&lt;-</span> <span class="va">after_control_B</span> <span class="op">-</span> <span class="va">before_control_B</span></span>
<span></span>
<span><span class="co"># Increase from t0 to before treatment</span></span>
<span><span class="va">init_treatment_B</span> <span class="op">&lt;-</span> <span class="va">df_B</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">period</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></span>
<span><span class="va">diff_treatment_B</span> <span class="op">&lt;-</span>  <span class="op">(</span><span class="va">before_treatment_B</span> <span class="op">-</span> <span class="va">init_treatment_B</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot event study</span></span>
<span><span class="va">ev_stdy_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_B</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">.5</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_B</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">period</span> <span class="op">&gt;=</span> <span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">sales_cf</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>           xend <span class="op">=</span> <span class="va">P</span>,</span>
<span>           y <span class="op">=</span> <span class="va">before_treatment_B</span>,</span>
<span>           yend <span class="op">=</span> <span class="va">before_treatment_B</span> <span class="op">+</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">diff_treatment_B</span><span class="op">)</span>,</span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Estimated treatment effect</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, xend <span class="op">=</span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="va">after_treatment_B</span>, yend <span class="op">=</span> <span class="va">after_treatment_B</span> <span class="op">-</span> <span class="va">diff_diff_B</span>,</span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="fu">ggthemr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemr/man/swatch.html">swatch</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Custom scaling and legend</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>name   <span class="op">=</span> <span class="st">"Period"</span>, breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">P</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Sales"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control Group"</span>, <span class="st">"Treatment Group"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Scenario B\nEvent Study"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-figure quarto-figure-center" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure"><p><a href="07_did_files/figure-html/unnamed-chunk-9-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="For treatment and control group, we see the same trend over time. This lends credibility to the parallel trends assumption and consequently, to the validity of the causal treatment effect."><img src="07_did_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">For treatment and control group, we see the same trend over time. This lends credibility to the parallel trends assumption and consequently, to the validity of the causal treatment effect.</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure"><p><a href="07_did_files/figure-html/unnamed-chunk-9-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Other than in scenario A, the parallel trends assumption does not seem to hold. The estimated treatment effect is larger than the actual treatment effect. This is due to different trends in both groups. The treatment group has a more positive trend even without treatment and the groups would have further diverged after treatment (see dashed red line). The difference between the dashed red and dashed blue line is attributable to this trend and should not be part of the treatment effect."><img src="07_did_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Other than in scenario A, the parallel trends assumption does not seem to hold. The estimated treatment effect is larger than the actual treatment effect. This is due to different trends in both groups. The treatment group has a more positive trend even without treatment and the groups would have further diverged after treatment (see dashed red line). The difference between the dashed red and dashed blue line is attributable to this trend and should not be part of the treatment effect.</figcaption></figure>
</div>
</div>
</div>
</section><section id="modeling" class="level2"><h2 class="anchored" data-anchor-id="modeling">Modeling</h2>
<p>A more typical situation is usually that there is more than one unit in the treatment and control group. You could e.g.&nbsp;imagine that you are managing more than two stores and are implementing an ad campaign in a specific region.</p>
<p>To simulate such a scenario, we generate data for 3’000 stores that are split evenly into two regions. In one region, the ad campaign will be run (treatment region) and in the other there will be no campaign (control region). The variable relationships as defined in the previous section still hold.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.4] Linear regression ----</span></span>
<span><span class="co"># Now assume that there are more than two stores and treatment is performed</span></span>
<span><span class="co"># in a specific region which is, depending on scenario (A) and (B) </span></span>
<span><span class="co"># different to the control region.</span></span>
<span></span>
<span><span class="co"># Generate a bunch of samples and combine in one table. Here, we choose a higher</span></span>
<span><span class="co"># standard deviation.</span></span>
<span><span class="co"># We assume that we only have data from one period prior and one period after </span></span>
<span><span class="co"># treatment.</span></span>
<span><span class="va">n_stores</span> <span class="op">&lt;-</span> <span class="fl">3e+3</span></span>
<span></span>
<span><span class="co"># Scenario A</span></span>
<span><span class="va">df_A_lm</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_stores</span>, <span class="kw">function</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">generate_data</span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span>, scenario <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">period</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scenario B</span></span>
<span><span class="va">df_B_lm</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_stores</span>, <span class="kw">function</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">generate_data</span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span>, scenario <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">period</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">P</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="scenario-a-1" class="level3"><h3 class="anchored" data-anchor-id="scenario-a-1">Scenario A</h3>
<p>So how do we compute the average treatment effect? Previously in this chapter, we just used basic math calculations (particularly subtraction). But there is an easier way: we can use regression again. This is because the average treatment effect is the coefficient of the interaction of group and time.</p>
<p><span class="math display">\[
y_i = \beta_0 + \beta_1 * Period_i + \beta_2 * Treatment_i + \beta_3 * (Time_i \times Treatment_i) + \epsilon_i
\]</span></p>
<p><span class="math inline">\(Time\)</span> indicates whether the period is before or after the treatment and <span class="math inline">\(Treatment\)</span> whether an observation belongs to the treatment group. We can interpret the estimated coefficient <span class="math inline">\(\hat\beta_1\)</span> as the time effect for both groups, it indicates how the outcome evolves without treatment. <span class="math inline">\(\hat\beta_2\)</span> represents the time-invariant level difference between groups, it is positive when the treatment group initially exhibited a higher outcome level.</p>
<p>What we are primarily interested in is the interaction <span class="math inline">\(Time \times Treatment\)</span> and its estimate <span class="math inline">\(\hat\beta_3\)</span>. It is only active for the treatment group after the treatment (<span class="math inline">\(Time = 1\)</span>, <span class="math inline">\(Treatment=1\)</span>) and represents the average treatment effect.</p>
<p>For scenario A, we can see that there is no need to adjust for the covariate <span class="math inline">\(x1\)</span>. You could for example think of <span class="math inline">\(x_1\)</span> as the purchase power of the respective region. If you check the formulas again, your will notice that <span class="math inline">\(x1\)</span> has a constant and time-invariant effect on sales and therefore it does not violate the parallel trends assumption.</p>
<p>Including or leaving out <span class="math inline">\(x1\)</span> in the regression yields a very similar unbiased estimate (close to defined true size) for our variable of interest <span class="math inline">\(store:after\)</span>, the parameter of interest.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.4.1] (A) ----</span></span>
<span><span class="co"># (a): Due to the construction of the data set, we expect interaction</span></span>
<span><span class="co"># coefficient to be significant as well as the covariate and period. However, as</span></span>
<span><span class="co"># the covariate does not have a time-varying effect, it is not a confounder and</span></span>
<span><span class="co"># interaction coefficient should be unbiased even if not adjusting for the</span></span>
<span><span class="co"># covariate.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">after</span> , data <span class="op">=</span> <span class="va">df_A_lm</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sales ~ treat * after, data = df_A_lm)

Residuals:
   Min     1Q Median     3Q    Max 
-5.176 -0.952  0.002  0.956  6.392 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  50.9610     0.0257 1981.43   &lt;2e-16 ***
treat         1.0372     0.0364   28.52   &lt;2e-16 ***
after         0.2642     0.0364    7.26    4e-13 ***
treat:after   0.9813     0.0514   19.08   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.4 on 11996 degrees of freedom
Multiple R-squared:  0.284, Adjusted R-squared:  0.284 
F-statistic: 1.58e+03 on 3 and 11996 DF,  p-value: &lt;2e-16</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">after</span> <span class="op">+</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">df_A_lm</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sales ~ treat * after + x1, data = df_A_lm)

Residuals:
   Min     1Q Median     3Q    Max 
-3.947 -0.680  0.000  0.673  4.204 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 50.98128    0.01821 2800.25   &lt;2e-16 ***
treat        0.03914    0.02732    1.43     0.15    
after        0.22876    0.02575    8.88   &lt;2e-16 ***
x1           0.98721    0.00903  109.31   &lt;2e-16 ***
treat:after  0.97808    0.03641   26.86   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1 on 11995 degrees of freedom
Multiple R-squared:  0.641, Adjusted R-squared:  0.641 
F-statistic: 5.36e+03 on 4 and 11995 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
</section><section id="scenario-b-1" class="level3"><h3 class="anchored" data-anchor-id="scenario-b-1">Scenario B</h3>
<p>In scenario B, the effect of <span class="math inline">\(x_1\)</span> is different because it has a time-varying effect. Therefore it violates the parallel trends assumption, leading to a biased estimate if <span class="math inline">\(x_1\)</span> is not included (e.g.&nbsp;because it is unobserved).</p>
<p>Because we constructed the data set ourselves, we are able to see that the bias in fact is quite large and the treatment effect seems to include the actual treatment effect plus the effect of <span class="math inline">\(x_1\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1.4.2] (B) ----</span></span>
<span><span class="co"># (b): Due to the construction of the data set, we expect interaction coefficient</span></span>
<span><span class="co"># to be significant and accurate only when adjusting for the time-varying effect</span></span>
<span><span class="co"># of the covariate and main effects for period and covariate.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">after</span>, data <span class="op">=</span> <span class="va">df_B_lm</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sales ~ treat * after, data = df_B_lm)

Residuals:
    Min      1Q  Median      3Q     Max 
-15.025  -2.331   0.008   2.293  16.433 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  51.0835     0.0643  794.08   &lt;2e-16 ***
treat         3.6321     0.0910   39.92   &lt;2e-16 ***
after         0.0682     0.0910    0.75     0.45    
treat:after   1.4315     0.1287   11.13   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.5 on 11996 degrees of freedom
Multiple R-squared:  0.287, Adjusted R-squared:  0.287 
F-statistic: 1.61e+03 on 3 and 11996 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<p>Only with including <span class="math inline">\(x_1\)</span> and as a main effect and moderator, we can reconstruct the true treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Including time-varying effect</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">after</span> <span class="op">+</span> <span class="va">after</span><span class="op">*</span><span class="va">x1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">*</span><span class="va">x1</span>, data <span class="op">=</span> <span class="va">df_B_lm</span><span class="op">)</span><span class="op">)</span> <span class="co"># best</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sales ~ treat * after + after * x1 + treat * x1, 
    data = df_B_lm)

Residuals:
   Min     1Q Median     3Q    Max 
-4.084 -0.682  0.001  0.679  4.348 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 51.00199    0.01818 2804.68  &lt; 2e-16 ***
treat        0.00336    0.03012    0.11     0.91    
after        0.16597    0.02571    6.45  1.1e-10 ***
x1           2.63804    0.01591  165.81  &lt; 2e-16 ***
treat:after  1.00018    0.04063   24.62  &lt; 2e-16 ***
after:x1     0.36083    0.01823   19.80  &lt; 2e-16 ***
treat:x1     1.03128    0.01823   56.57  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1 on 11993 degrees of freedom
Multiple R-squared:  0.943, Adjusted R-squared:  0.943 
F-statistic: 3.31e+04 on 6 and 11993 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
</section></section></section><section id="conclusion" class="level1"><h1>Conclusion</h1>
<p>DiD is a useful quasi-experimental method that relies on the parallel trends assumption which is untestable. We can’t prove it but try to justify it by for example showing prior trends. If both groups were evolving similarly before the treatment, that supports the plausibility and appropriateness of using DiD.</p>
<p>DiD is a very actively researched methods and can be extended too many scenarios: e.g.&nbsp;the synthetic control method, that is able to deal with one treated and multiple untreated groups. By matching and weighting the untreated groups, a synthetic group is composed, that is similar in the lead up to the treatment period. It shares similarities with what we have done in the matching chapter. Sometimes you also might end up with many treatment groups and variation in treatment timing. Although you have to be careful with your assumptions and specifications, such cases can also be incorporated into a DiD framework.</p>
</section><section id="assignment" class="level1"><h1>Assignment</h1>
<p>Imagine, you are manager of a large health provider that manages many hospitals and you want to test how a new admission procedure affects patient satisfaction. You randomly selected 18 hospitals that introduced the new admission procedure and compare them to 28 other hospitals that did not introduce the method. For both groups of hospitals you collected data from before and after the introduction. The data you have collected is from patient surveys where they were asked how satisfied they are.</p>
<p>Load the data from the file <code>hospdd.rds</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Then, perform a difference-in-differences analysis by</p>
<ol type="1">
<li><p>Manually computing the mean satisfaction for treated and control hospitals before and after the treatment. Helpful functions could be <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/pull.html">pull()</a></code> and basic arithmetic operations.</p></li>
<li>
<p>Using a linear regression to compute the estimate. Also, include group and time fixed effects in the regression, i.e.&nbsp;one regressor for each month and one regressor for each hospital: Consider, whether you want to include them as</p>
<ul>
<li><p><code>month + hospital</code> or as</p></li>
<li><p><code>as.factor(month) + as.factor(hospital)</code></p></li>
</ul>
<p>and explain what the difference is.</p>
</li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to submit your solutions!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please see <a href="https://owmork.github.io/causal_ds/submission/submission.html">here</a> how you have to successfully submit your solutions. I would recommend you to solve the assignments first in <code>.R</code> scripts and in the end convert them to the required format as explained in the submission instructions.</p>
</div>
</div>


</section><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>Data and example from: <a href="https://www.stata.com/new-in-stata/difference-in-differences-DID-DDD/" class="uri">https://www.stata.com/new-in-stata/difference-in-differences-DID-DDD/</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../content/toolbox/06_match.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Matching and Subclassification</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/toolbox/08_iv.html" class="pagination-link">
        <span class="nav-page-text">Instrumental Variables</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Winter term 2022/2023 - Causal Data Science for Business Analytics</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"openEffect":"zoom","closeEffect":"zoom","selector":".lightbox","descPosition":"bottom","loop":true});</script>


</body></html>